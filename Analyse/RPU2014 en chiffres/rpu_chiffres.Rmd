---
title: "RPU 2014 en chiffres"
author: "JcB"
date: "31/12/2014"
output:
  html_document:
    toc: yes
---

Chiffres pour l'année 2014
==========================

init
----
Le fichier source s'appelle __d14__.

```{r init, echo=FALSE}
<<<<<<< HEAD
# XPS load("~/Documents/Resural/Stat Resural/RPU_2014/rpu2014d0112.Rda")
# MAc
load("../../rpu2014d0112.Rda")
=======
load("~/Documents/Resural/Stat Resural/RPU_2014/rpu2014d0112_c.Rda")
>>>>>>> bceb26baa9cadd95dcb95df9b503359a64c1769f

# intégration du Finess Juridique pour la clinique Ste Odile. Erreur signalée par Mr Nold: certains RPU de Ste Odile contiennent le Finess juridique au lieu du géographique
d14$FINESS <- as.character(d14$FINESS)
d14$FINESS[d14$FINESS=="670780204"]<-"Odi"
d14$FINESS <-  factor(d14$FINESS) # élimine les facteus vides

library(lubridate)
library(knitr)

anc <- year(as.Date(d14$ENTREE[1])) # année courante

MOIS <- format(ISOdate(anc, 1:12, 1), "%B") # noms des mois
mois <- format(ISOdate(anc, 1:12, 1), "%b") # noms des mois abrégés

# pour que la semaine commence un lundi, il faut choisir 2007 comme année de référence
SEMAINE <- format(ISOdate(2007, 1, 1:7), "%A") # noms des jours de la semaine
semaine <- format(ISOdate(2007, 1, 1:7), "%a") # noms des jours de la semaine abrégés

```

Créer un calendrier
===================

Pb: on veut créer un vecteur de 365 ou 366 jours.

```{r}
date1 <- "2014-01-01"
date2 <- "2014-12-31"
calendrier <- seq(from = as.Date(date1), to = as.Date(date2), by = 1)

```

Compter les jours d'une semaine
===============================

Pb: on veut compter le nombre de lundi, merdi, ..., dimanche au cours d'une période de temps

```{r}
tapply(calendrier, wday(calendrier, label = TRUE), length)

```



Total RPU
=========
```{r total, echo=FALSE}
n <- nrow(d14)

```
Total RPU: `r n`

Nombre de RPU par jour
=======================

```{r jour, echo=FALSE}

nb.rpu.par.jour <- tapply(as.Date(d14$ENTREE), as.Date(d14$ENTREE), length)
mean(nb.rpu.par.jour)
sd(nb.rpu.par.jour)
median(nb.rpu.par.jour)

# nb RPU par semaine ET jour de semaine. Nécessite Lubridate. Génère une latrice 52  x 7
a <- tapply(as.Date(d14$ENTREE), list(week(as.Date(d14$ENTREE)), wday(as.Date(d14$ENTREE))), length)
# moyenne par type de jour (1 = dimanche)
apply(a, 2, mean, na.rm = TRUE)
apply(a, 2, sd, na.rm = TRUE)
# moyenne par semaine
mean.week <- apply(a, 1, mean, na.rm = TRUE)
sd.week <- apply(a, 1, sd, na.rm = TRUE)
```


Nombre de RPU par mois
======================

Pb: on veut connaître le nombre de RPU par mois en 2014. Utilisé par le site internet. On utilise la fonction _tapply_ pour calculer la répartition mensuelle.

```{r}
# en valeur absolue
t <- tapply(as.Date(d14$ENTREE), month(as.Date(d14$ENTREE)), length)
names(t) <- format(ISOdate(2000, 1:12, 1), "%B")
t
# en pourcentage
round(prop.table(t)*100, 2)
# en différence. Rajoute 1 pour le mois de janvier
d <- c(1 ,diff(t))
names(d[1]) <- "janvier" # marche pas ?
barplot(d[1:11], col = ifelse(d > 0, "yellow", "green"), main = paste0("Variation du nombre de RPU en ", anc))

```

Nombre de RPU par semaine
=========================

Il y a deux méthodes possibles:

- __weekday__s du package _main_:
```{r}
wd <- tapply(as.Date(d14$ENTREE), weekdays(as.Date(d14$ENTREE)), length)
wd

```
- __wday__ du package _lubridate_. Inconvénient, la semaine commence le dimanche.
```{r}
# jours de semaine indicés par des entiers
wd <- tapply(as.Date(d14$ENTREE), wday(as.Date(d14$ENTREE)), length)
wd

# jours indicés par leur nom
wd <- tapply(as.Date(d14$ENTREE), wday(as.Date(d14$ENTREE), label = TRUE), length)
wd
```

Possibilité de correction:
```{r}
a <- c(wd[2:7],wd[1]) # on met le dimanche en dernier
names(a) <- SEMAINE
a

```

Nombre de RPU par établissements
--------------------------------
```{r}
tapply(as.Date(d14$ENTREE), d14$FINESS, length)

```

Nombre de RPU par territoires de santé
--------------------------------------
On crée une colonne supplémentaire pour les territoires de santé. La colonne crée est de type character.

```{r}
d14$TERRITOIRE[d14$FINESS %in% c("Wis","Sav","Hag")] <- "T1"
d14$TERRITOIRE[d14$FINESS %in% c("Hus","Odi","Ane","Dts")] <- "T2"
d14$TERRITOIRE[d14$FINESS %in% c("Sel","Col","Geb")] <- "T3"
d14$TERRITOIRE[d14$FINESS %in% c("Mul","3Fr","Alk","Ros","Dia")] <- "T4"

tapply(as.Date(d14$ENTREE), d14$TERRITOIRE, length)

```
Nombre de RPU par établissements
-------------------------------
```{r rpu_etab, echo=FALSE, comment=""}
summary(factor(d14$FINESS))
```

Nombre de RPU par mois et par établissement
-------------------------------------------
```{r mois_etab, echo=FALSE, comment=""}
tapply(as.Date(d14$ENTREE), list(month(as.Date(d14$ENTREE)), factor(d14$FINESS)), length)

```


HUS
===

```{r hus, echo=FALSE, comment=""}
hus <- d14[d14$FINESS == "Hus",]

```

Activité mensuelle
------------------
```{r hus_mois, echo=FALSE, comment=""}
tapply(as.Date(hus$ENTREE), month(as.Date(hus$ENTREE)), length)

```
Activité pédiatrique mensuelle
------------------------------
```{r}
hus.ped <- hus[hus$AGE < 18,]

tapply(as.Date(hus.ped$ENTREE), month(as.Date(hus.ped$ENTREE)), length)

```



Demande ARS 2015 02
===================

Date: 2014-01-07

Dans le cadre de l'évaluation des CPOM des établissements, mais également en lien avec le travail qui s'initie en interne concernant la prise en charge de la personne âgée, nous souhaiterions pouvoir disposer des données par établissement concernant:
- le nombre de primo passages, et la proportion des patients de 75 ans et plus, en incluant les données de l'année 2014 (en précisant le niveau d'exhaustivité atteint dans la base 2014 à ce jour de la requête).
- la moyenne/médiane des temps de passages pour tout âge et pour les 75 ans et plus.
 
En y incluant les Diaconesses et la clinique Roosevelt, et des totaux par territoires de santé et pour la région.
 
Ci-joint un tableau pour clarifier la demande, avec certaines données déjà remplies à partir de la dernière version du rapport 2013.
 
Avez-vous d'ores et déjà des éléments d'explication (liés au codage notamment) au regard des temps de passage très hétérogènes d'une SU à l'autre?

Elements de réponse

nombre de primo passages
------------------------
`r n`

proportion de 75 ans et plus
----------------------------
```{r}
pop_75ans <- d14[d14$AGE > 74, "AGE"]
n_75ans <- length(pop_75ans)

summary(pop_75ans)
```
Exhaustivité pour l'âge: `r mean(!is.na(n_75ans) * 100)` %

proportion des 75 ans: `r round(n_75ans * 100 / n, 2)` %.

Durée de passage chez les plus de 75 ans
----------------------------------------
```{r}
dp <- d14[!is.na(d14$ENTREE) & !is.na(d14$SORTIE) & d14$AGE > 74, c("SORTIE", "ENTREE", "AGE", "FINESS")]
mean(!is.na(dp$SORTIE))
mean(!is.na(dp$ENTREE))
sum(is.na(dp$ENTREE))
sum(is.na(dp$SORTIE))
dp <- dp[!is.na(dp$SORTIE) & !is.na(dp$ENTREE),]
```
Exhaustivité de 99%. Seuls 4 passages ne sont pas renseignés.

```{r presence}
# vecteur des heures d'entrées
s <- ymd_hms(dp$SORTIE)
# vecteurs des heures de sortie
e <- ymd_hms(dp$ENTREE)
# durée de présence en secondes
p <- s - e
length(p)
summary(as.numeric(p))
# résumé en minutes
summary(as.numeric(p)/60)

# vecteur des durée de présence en mn
p_mn <- as.numeric(p)/60
H48 <- 60 * 48
# durée de présence comprises entre 0 et 48 heures
p48 <- p_mn[p_mn < H48 + 1]
summary(p48)
length(p48)
# histogramme par tranche d'une heure
hist(p48, breaks = seq(0, 60*48, 60), main = "Durée de passage (par tranche d'une heure) \ndes patients de 75 ans et plus", xlab = "temps en minutes de 0 à 2880 minutes (48 heures)", ylab = "fréquence")

```
La durée de passage est bornée à 48 heures (recommandation FEDORU).

```{r}

```


Demande 3 2015-01-12
====================

Suite à notre conversation téléphonique, pouvez-vous en priorité, me communiquer cette semaine les totaux de priomopassages par établissement/et territoire de santé pour l'année 2014?
 
En cas de difficulté en termes de délais, les précisions concernant les personnes de plus de 75 ans demandées dans cette présente requête (ci-dessous), ainsi que les précisions concernant la requête précédente (dans le cadre du groupe de travail sur les chutes des personnes âgées), pourront attendre la semaine prochaine (avant le 22).

réponse le 2015-01-12 (cf supra)
