---
title: "Temps de passage"
author: "JcB"
date: "11/02/2015"
output: html_document
---

Temps de passage est la durée entre l'heure d'entrée et l'heure de sortie.

```{r init, echo=FALSE, message=FALSE}

library(lubridate)
library(xts)

path <- "../../"
load(paste0(path, "rpu2014d0112_c.Rda")) # 2014
source(paste0(path,"Preparation/RPU Quotidiens/quot_utils.R"))

# ajout de janvier 2015
load(paste0(path, "rpu2015d01.Rda"))
d14 <- rbind(d14, d01)

# on enlève les HUS
# d14 <- d14[d14$FINESS != "Hus",]

# Uniquement Sélestat
# d14 <- d14[d14$FINESS == "Sel",]


# intégration du Finess Juridique pour la clinique Ste Odile. Erreur signalée par Mr Nold: certains RPU de Ste Odile contiennent le Finess juridique au lieu du géographique
d14$FINESS <- as.character(d14$FINESS)
d14$FINESS[d14$FINESS=="670780204"]<-"Odi"
d14$FINESS <-  factor(d14$FINESS) # élimine les facteus vides
```

Données générales
-----------------
```{r}
e <- ymd_hms(d14$ENTREE) # vecteur des entrées
s <- ymd_hms(d14$SORTIE) # vecteur des sorties
d <- as.numeric((s-e)/60) # vecteur des durées de passage en minutes
sdp <- summary(d)
sdp

inf <- d[d < 0 & !is.na(d)] # dp négatives
zero <- d[d == 0 & !is.na(d)] # dp nulles
na <- d[is.na(d)] # les NA

sup1 <- d[d > 1*24*60 & !is.na(d)] # dp > 1 jour
sup2 <- d[d > 2*24*60 & !is.na(d)] 
sup3 <- d[d > 3*24*60 & !is.na(d)]
sup4 <- d[d > 4*24*60 & !is.na(d)]
sup5 <- d[d > 5*24*60 & !is.na(d)]
sup6 <- d[d > 6*24*60 & !is.na(d)] # dp > 6 jour
sup6/(24*60) # 3 dossiers > 6 jours

d14$DPAS <- d # on crée une colonne sup

# nb de durée de passage incomplète par établisement
dp.na <- d14$FINESS[is.na(d14$DPAS)]
sdp.na <- summary(na)
nfiness <- summary(d14$FINESS) # nb de rpu par établissement
round(sdp.na * 100 / nfiness, 2) # % de durée de passage in complète
# présentation en tableau
t <- rbind(sdp.na, nfiness, round(sdp.na * 100 / nfiness, 2))
rownames(t) <- c("RPUa", "RPUt", "%")
t

# finalement on ne garde que les RPU avec une durée de passage exploitable et qui soit positive et inférieure ou égale à 48 heures.
p14 <- d14[!is.na(d14$DPAS) & d14$DPAS > 0 & d14$DPAS <= 2*24*60, ]
# save(p14, file = "dpassage_2014.Rda")
```

On ne garde que les RPU avec une durée de passage exploitable et qui soit positive et inférieure ou égale à 48 heures.

- nombre de RPU exploitable: `r format(nrow(p14), big.mark = " ")`
- nombre de RPU totaux: `r format(nrow(d14), big.mark = " ")`

Analyse des durées de passage > 6 heures
----------------------------------------

```{r}
# RPU avec durée de passage > 6h. 
p6h <- p14[p14$DPAS > 6*60, c("ENTREE", "FINESS")]
t <- tapply(as.Date(p6h$ENTREE), as.Date(p6h$ENTREE), length) # RPU de plus de 6 heures par jour

# PB: ILPEUT Y AVOIR DES JOURS SANS PASSAGE  > 6 HEURES (EX. SELESTAT) => FAIRE UN MERGING AVEC UN CALENDRIER.
# OK: AJUSTER LE CALENDRIER 0 LA TAILLE DE D14
# if (length(t) < 365){
#   # creéer un calendrier
#   date1 <- min(d14$ENTREE)
#   date2 <- max(d14$ENTREE)
#   calendrier <- seq(from = as.Date(date1), to = as.Date(date2), by = 1)
#   a <- as.data.frame(calendrier)
# 
#   # transforme t en dataframe pour merger ATTENTION: ne pas mettre as.data.frame
#   t <- data.frame(t, as.Date(names(t)))
#   # merging
#   b <- merge(a, t, by.y = "as.Date.names.t..", by.x = "calendrier", all.x = TRUE)
#   t <- b
# }
summary(t) # résumé passage de plus de 6 heures"
plot(t, type='l', main = "Nombre de RPU dont la durée de passage est supérieure à 6 heures", ylab = "Nombre de RPU", xlab = "Jours (2014)")


# pour gommer l'effet lié à l'augmentation des RPU en cours d'année (HUS), on forme le rapport RPU avec passage de plus de 6 heures sur RPU totaux:
ptot <- d14[, c("ENTREE", "FINESS")]
t.tot <- tapply(as.Date(ptot$ENTREE), as.Date(ptot$ENTREE), length) # RPU totaux par jour
# TODO: IL FAUT ÉGALEMENT FAIRE UN MERGING ENTRE CALENDRIER ET T.TOT CAR PEUT ÊTRE PLUS COURT +++ (pb avec Sélestat)

#r <- as.numeric(t$t)/t.tot # rapport
r <- as.numeric(t)/t.tot # rapport

plot(r, type='l', main = "% de RPU dont la durée de passage est supérieure à 6 heures", ylab = "% de RPU avec DP > 6 heures", xlab = "Jours (2014)")

# version xts
rxps <- xts(r, order.by = as.Date(rownames(r)))
# graphique seul
plot(rxps, type='l', main = "% de RPU dont la durée de passage est supérieure à 6 heures", ylab = "% de RPU avec DP > 6 heures", minor.ticks = FALSE)
# moyenne mobile seule
plot(rollmean(rxps, k = 7), col = "blue", minor.ticks = FALSE, main = "% de RPU dont la durée de passage est supérieure à 6 heures", ylab = "% de RPU avec DP > 6 heures")
legend("bottomleft", legend = "moyenne lissée", col = "blue", lty = 1, bty = "n")
# les deux graphiques
plot(rxps, type='l', main = "% de RPU dont la durée de passage est supérieure à 6 heures", ylab = "% de RPU avec DP > 6 heures", minor.ticks = FALSE)
lines(rollmean(rxps, k = 7), col = "blue")
legend("bottomleft", legend = "moyenne lissée", col = "blue", lty = 1, bty = "n")

```

